<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Resolution Builder - PyleaMUN</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <img src="logo.png" alt="PyleaMUN Logo" id="logo" />
    <h1>Live Resolution Builder</h1>
  </header>
  <main>
    <div id="login-container">
      <h3>Role:</h3>
      <select id="role" onchange="handleRoleChange()">
        <option value="delegate">Delegate</option>
        <option value="chair">Chair</option>
      </select>

      <div id="chair-password" style="display:none;">
        <h3>Chair Password:</h3>
        <input type="password" id="chair-password-input" placeholder="Enter chair password" />
      </div>

      <h3>Committee:</h3>
      <select id="committee" onchange="updateBlocDisplays()">
        <option value="unep">UNEP</option>
        <option value="security">Security Council</option>
        <option value="ecosoc">ECOSOC</option>
        <option value="unesco">UNESCO</option>
        <option value="nato">NATO</option>
        <option value="who">WHO</option>
        <option value="hrc">HRC</option>
        <option value="unwomen">UN Women</option>
      </select>
      <input type="password" id="committee-code" placeholder="Enter committee code" />

      <div id="delegate-bloc-container" style="display:none;">
        <h3>Join Bloc:</h3>
        <select id="available-blocs" onchange="checkBlocSelection()">
          <option value="">Select a bloc</option>
        </select>
        <input type="password" id="bloc-password" placeholder="Bloc password" />
      </div>

      <button onclick="enterEditor()" id="enter-button">Enter</button>
    </div>

    <div id="editor-container" style="display:none;">
      <div id="info-bar">
        <span id="user-info"></span>
        <button id="lock-toggle" onclick="toggleLock()">üîí Lock</button>
        <span id="timer">00:00</span>
        <button id="set-timer" onclick="setTimer()">‚è±Ô∏è Set Timer</button>
        <button id="start-timer" onclick="startTimer()">‚ñ∂Ô∏è</button>
        <button id="pause-timer" onclick="pauseTimer()">‚è∏Ô∏è</button>
        <button id="reset-timer" onclick="resetTimer()">‚èπÔ∏è</button>
        <button id="export-pdf" onclick="exportToPDF()">üìÑ Export PDF</button>
      </div>

      <div id="chair-controls" style="display:none;">
        <div class="chair-section">
          <h3>Create New Bloc:</h3>
          <input type="text" id="new-bloc-name" placeholder="Bloc name" />
          <input type="password" id="new-bloc-password" placeholder="Bloc password" />
          <button onclick="createBloc()">Create Bloc</button>
        </div>
        <div id="existing-blocs"></div>
      </div>

      <div id="bloc-selector" style="display:none;">
        <h4>Select Bloc to View:</h4>
        <select id="chair-bloc-select" onchange="onChairBlocSelect()">
          <option value="">Select a bloc</option>
        </select>
      </div>

      <div id="resolution-header">
        <div class="header-field">
          <label>FORUM:</label>
          <input type="text" id="forum" placeholder="Enter forum name" />
        </div>
        <div class="header-field">
          <label>QUESTION OF:</label>
          <input type="text" id="question-of" placeholder="Enter question" />
        </div>
        <div class="header-field">
          <label>SUBMITTED BY:</label>
          <input type="text" id="submitted-by" placeholder="Enter submitting countries" />
        </div>
        <div class="header-field">
          <label>CO-SUBMITTED BY:</label>
          <input type="text" id="co-submitted-by" placeholder="Enter co-submitting countries" />
        </div>
      </div>

      <div id="clauses">
        <h3>Preambulatory Clauses</h3>
        <div id="preambulatory-buttons"></div>
        <h3>Operative Clauses</h3>
        <div id="operative-buttons"></div>
      </div>

      <div id="resolution-display">
        <h3>Resolution Preview</h3>
        <textarea id="resolution-text" readonly style="background: #f8f9fa; border: 2px solid #dee2e6;"></textarea>
      </div>

      <div id="comments-section">
        <h3>Comments</h3>
        <div id="comments-list"></div>
        <div id="comment-controls">
          <input type="text" id="comment-input" placeholder="Add a comment (chairs only)" />
          <button id="add-comment" onclick="addComment()">Add Comment</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase SDKs and Initialization -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, collection, addDoc, query, orderBy, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Your web app's Firebase configuration
    // Use the global __firebase_config variable provided by the Canvas environment
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyC_IHwSSoRxcysu4QZRewZdqhhD1LuF0xQ",
      authDomain: "pyleamun-resolution-builder.firebaseapp.com",
      projectId: "pyleamun-resolution-builder",
      storageBucket: "pyleamun-resolution-builder.firebasestorage.app",
      messagingSenderId: "249510999834",
      appId: "1:249510999834:web:b6e714939292210fd19ea3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Make Firebase instances and functions globally accessible for app.js
    window.db = db;
    window.auth = auth;
    window.firebase = {
        getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove,
        collection, addDoc, query, orderBy, getDoc, serverTimestamp,
        getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously
    };

    // Use the __app_id and __initial_auth_token provided by the Canvas environment
    // This ensures authentication works correctly within the Canvas iframe.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Authenticate with the provided token or anonymously
    async function authenticateFirebase() {
        try {
            if (initialAuthToken) {
                await firebase.signInWithCustomToken(auth, initialAuthToken);
                console.log("Signed in with custom token.");
            } else {
                await firebase.signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }
        } catch (error) {
            console.error("Firebase authentication error:", error);
        }
    }

    authenticateFirebase();

  </script>
  <script src="app.js"></script>
</body>
</html>
